<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Pocket Golf</title>
<style>
  :root{
    --bg:#0b5d2a; --fg:#e9fff0; --panel:#0f7a37; --shadow:rgba(0,0,0,.35);
    --accent:#a0ffcf; --ink:#06381a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#0a4c23,#0e6b31);color:var(--fg)}
  .wrap{max-width:420px;margin:0 auto;padding:12px}
  h1{margin:8px 0 4px;text-align:center;letter-spacing:.4px;text-shadow:0 2px 6px var(--shadow)}
  .card{background:linear-gradient(180deg,#118640,#0e6b33);border:1px solid #0b5526;border-radius:16px;box-shadow:0 12px 22px var(--shadow) inset,0 8px 18px var(--shadow);padding:12px;margin:10px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .stack{display:flex;flex-direction:column;gap:8px}
  button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-size:16px;font-weight:800;color:var(--ink);background:linear-gradient(180deg,#cbffd6,#83ffb6);box-shadow:0 4px 0 #3db174,0 8px 18px var(--shadow);cursor:pointer}
  button[disabled]{opacity:.5;filter:grayscale(40%);box-shadow:none;cursor:not-allowed}
  .ghost{background:linear-gradient(180deg,#eafff1,#b7ffd2)}
  #menu,#shop,#game{display:none}
  #game canvas{display:block;width:100%;height:auto;touch-action:none;background:radial-gradient(120% 120% at 50% 0%,#3bbf6a 0%, #219653 40%, #136c3a 100%);border-radius:16px;border:2px solid #0a4c23;box-shadow:0 10px 22px var(--shadow)}
  #hud{display:flex;justify-content:space-between;align-items:center;gap:8px;font-weight:800}
  #hud .left,#hud .right{display:flex;gap:8px;align-items:center}
  .pill{padding:4px 8px;border-radius:999px;background:#eafff2;color:var(--ink);font-size:12px}
  .tiny{font-size:12px;opacity:.8}
  .shop-item{display:flex;align-items:center;justify-content:space-between;gap:10px;background:rgba(0,0,0,.12);border:1px solid rgba(255,255,255,.15);padding:10px;border-radius:12px}
  .ball-swatch{width:26px;height:26px;border-radius:50%;border:2px solid rgba(0,0,0,.35);box-shadow:inset 0 8px 10px rgba(255,255,255,.35), inset 0 -6px 10px rgba(0,0,0,.35)}
  .club-toggle{display:flex;gap:8px}
  /* Summary overlay */
  #summary{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);padding:16px;z-index:10}
  #summary .panel{max-width:420px;width:100%;background:linear-gradient(180deg,#f0fff6,#cfffdf);color:#08371a;border-radius:16px;padding:16px;box-shadow:0 20px 30px var(--shadow)}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Pocket Golf - v1.6.1, Halloween Update</h1>

    <div id="menu" class="card stack">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong>Courses</strong>
        <span class="pill">Saves locally</span>
      </div>
      <div id="courseList" class="stack"></div>
      <div class="card">
        <strong>Best & Par</strong>
        <div id="bestScores" class="tiny"></div>
      </div>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>Coins: <strong id="menuCoins">0</strong></div>
        <div class="row">
          <button class="ghost" onclick="openShop()">Shop</button>
          <button class="ghost" onclick="resetProgress()">Reset Progress</button>
        </div>
      </div>
    </div>

    <div id="shop" class="card stack">
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong>Shop</strong>
        <div>Coins: <strong id="coins">0</strong></div>
      </div>
      <div id="shopItems" class="stack" style="width:100%"></div>
      <div class="row" style="justify-content:space-between">
        <button class="ghost" onclick="backToMenu()">Back</button>
      </div>
    </div>

    <div id="game" class="card">
      <div id="hud">
        <div class="left">
          <span id="hudHole">Hole 1/9</span>
          <span id="hudStrokes">Strokes: 0</span>
          <span id="hudScore">Score: E</span>
          <span id="hudPar" class="pill">Par 3</span>
        </div>
        <div class="right">
          <div class="club-toggle">
            <button class="ghost" id="clubBtn">Club: Driver</button>
          </div>
          <span>Coins: <strong id="hudCoins">0</strong></span>
          <button class="ghost" onclick="exitGame()">Exit</button>
        </div>
      </div>
      <canvas id="gameCanvas" width="390" height="640"></canvas>
      <div class="tiny">Pull back on the ball to aim.</div>
    </div>
  </div>

  <!-- End-of-course summary overlay -->
  <div id="summary">
    <div class="panel">
      <h3 style="margin:0 0 8px">Course Complete!</h3>
      <div id="summaryBody" class="tiny" style="font-size:14px"></div>
      <div class="row" style="margin-top:12px;justify-content:flex-end">
        <button onclick="summaryToMenu()">Back to Menu</button>
      </div>
    </div>
  </div>

<script>
// ======= Preset Courses (6 x 9 holes) =======
function R(x,y,w,h,type){ return {x,y,w,h,type}; }
// Each hole: {start:{x,y}, cup:{x,y}, par, obstacles:[...]}
const COURSES = [
  // 1) Meadow Run — beginner, open fairways
  [
    {start:{x:195,y:560}, cup:{x:195,y:90}, par:3, obstacles:[R(80,260,230,22,'sand')]},
    {start:{x:60,y:560},  cup:{x:320,y:110}, par:3, obstacles:[R(140,340,120,20,'green')]},
    {start:{x:330,y:560}, cup:{x:60,y:120},  par:3, obstacles:[R(100,300,190,18,'brown')]},
    {start:{x:195,y:560}, cup:{x:195,y:120}, par:3, obstacles:[R(60,360,270,20,'sand')]},
    {start:{x:60,y:560},  cup:{x:330,y:120}, par:4, obstacles:[R(150,300,60,18,'green'),R(200,220,80,18,'brown')]},
    {start:{x:330,y:560}, cup:{x:60,y:100},  par:3, obstacles:[R(120,320,160,22,'sand')]},
    {start:{x:195,y:560}, cup:{x:195,y:90},  par:3, obstacles:[R(80,340,230,18,'green')]},
    {start:{x:60,y:560},  cup:{x:330,y:110}, par:3, obstacles:[R(60,240,270,20,'sand')]},
    {start:{x:330,y:560}, cup:{x:60,y:90},   par:4, obstacles:[R(90,280,210,18,'brown')]},
  ],
  // 2) Desert Dunes — sand-heavy, careful routing
  [
    {start:{x:195,y:560}, cup:{x:195,y:100}, par:4, obstacles:[R(40,380,310,24,'sand'),R(60,280,270,20,'sand')]},
    {start:{x:60,y:560},  cup:{x:330,y:120}, par:4, obstacles:[R(110,340,190,22,'sand'),R(160,220,110,18,'brown')]},
    {start:{x:330,y:560}, cup:{x:60,y:120},  par:4, obstacles:[R(90,360,230,24,'sand'),R(120,260,160,20,'sand')]},
    {start:{x:195,y:560}, cup:{x:195,y:90},  par:3, obstacles:[R(70,240,250,24,'sand'),R(100,320,190,20,'brown')]},
    {start:{x:60,y:560},  cup:{x:330,y:110}, par:4, obstacles:[R(70,340,250,24,'sand'),R(150,260,80,18,'green')]},
    {start:{x:330,y:560}, cup:{x:60,y:100},  par:4, obstacles:[R(60,360,270,24,'sand'),R(110,260,170,22,'sand')]},
    {start:{x:195,y:560}, cup:{x:195,y:110}, par:4, obstacles:[R(70,340,250,22,'sand'),R(130,260,130,20,'brown')]},
    {start:{x:60,y:560},  cup:{x:330,y:100}, par:4, obstacles:[R(80,360,240,24,'sand'),R(150,300,90,18,'green')]},
    {start:{x:330,y:560}, cup:{x:60,y:90},   par:4, obstacles:[R(60,340,270,24,'sand'),R(120,240,150,22,'sand')]},
  ],
  // 3) Forest Path — brown bumpers, precision banks
  [
    {start:{x:195,y:560}, cup:{x:195,y:120}, par:3, obstacles:[R(80,360,230,16,'brown'),R(120,280,150,16,'brown')]},
    {start:{x:60,y:560},  cup:{x:320,y:110}, par:4, obstacles:[R(60,260,270,18,'brown'),R(140,320,120,16,'brown')]},
    {start:{x:330,y:560}, cup:{x:60,y:110},  par:4, obstacles:[R(90,320,230,16,'brown'),R(120,240,160,16,'brown')]},
    {start:{x:195,y:560}, cup:{x:195,y:100}, par:3, obstacles:[R(70,340,250,18,'brown')]},
    {start:{x:60,y:560},  cup:{x:330,y:100}, par:4, obstacles:[R(140,260,120,16,'brown'),R(160,320,70,16,'brown')]},
    {start:{x:330,y:560}, cup:{x:60,y:120},  par:4, obstacles:[R(60,260,270,18,'brown'),R(120,340,150,18,'brown')]},
    {start:{x:195,y:560}, cup:{x:195,y:90},  par:3, obstacles:[R(120,320,150,16,'brown')]},
    {start:{x:60,y:560},  cup:{x:330,y:110}, par:4, obstacles:[R(90,340,230,16,'brown'),R(110,260,170,16,'brown')]},
    {start:{x:330,y:560}, cup:{x:60,y:100},  par:4, obstacles:[R(80,300,240,16,'brown'),R(140,240,120,16,'brown')]},
  ],
  // 4) Emerald Slides — green bouncers, ricochet play
  [
    {start:{x:195,y:560}, cup:{x:195,y:90},  par:3, obstacles:[R(90,360,210,18,'green'),R(140,280,110,18,'green')]},
    {start:{x:60,y:560},  cup:{x:330,y:110}, par:4, obstacles:[R(110,340,190,18,'green'),R(140,240,120,18,'green')]},
    {start:{x:330,y:560}, cup:{x:60,y:120},  par:3, obstacles:[R(80,320,230,18,'green')]},
    {start:{x:195,y:560}, cup:{x:195,y:120}, par:4, obstacles:[R(70,340,250,18,'green'),R(120,260,150,18,'green')]},
    {start:{x:60,y:560},  cup:{x:330,y:90},  par:4, obstacles:[R(150,320,80,18,'green'),R(60,260,270,18,'green')]},
    {start:{x:330,y:560}, cup:{x:60,y:100},  par:4, obstacles:[R(110,320,170,18,'green'),R(120,240,150,18,'green')]},
    {start:{x:195,y:560}, cup:{x:195,y:90},  par:3, obstacles:[R(120,320,150,18,'green')]},
    {start:{x:60,y:560},  cup:{x:330,y:120}, par:4, obstacles:[R(100,340,210,18,'green'),R(120,260,150,18,'green')]},
    {start:{x:330,y:560}, cup:{x:60,y:100},  par:4, obstacles:[R(80,320,230,18,'green'),R(140,260,120,18,'green')]},
  ],
  // 5) Chaos Peaks — mixed, tight gaps, highest par
  [
    {start:{x:195,y:560}, cup:{x:195,y:90},  par:4, obstacles:[R(70,360,250,20,'sand'),R(120,300,150,18,'green'),R(160,220,70,16,'brown')]},
    {start:{x:60,y:560},  cup:{x:330,y:120}, par:4, obstacles:[R(90,340,230,20,'sand'),R(150,280,80,16,'brown')]},
    {start:{x:330,y:560}, cup:{x:60,y:100},  par:4, obstacles:[R(110,360,170,20,'sand'),R(100,280,200,18,'green')]},
    {start:{x:195,y:560}, cup:{x:195,y:110}, par:3, obstacles:[R(60,340,270,18,'green'),R(120,260,150,18,'brown')]},
    {start:{x:60,y:560},  cup:{x:330,y:110}, par:4, obstacles:[R(70,360,250,20,'sand'),R(140,280,120,18,'green')]},
    {start:{x:330,y:560}, cup:{x:60,y:120},  par:4, obstacles:[R(90,320,230,18,'green'),R(120,240,160,18,'brown')]},
    {start:{x:195,y:560}, cup:{x:195,y:90},  par:3, obstacles:[R(110,320,170,18,'brown'),R(60,260,270,20,'sand')]},
    {start:{x:60,y:560},  cup:{x:330,y:100}, par:4, obstacles:[R(100,360,210,20,'sand'),R(140,300,120,18,'green')]},
    {start:{x:330,y:560}, cup:{x:60,y:90},   par:5, obstacles:[R(70,320,250,18,'green'),R(120,260,150,18,'sand'),R(160,210,70,16,'brown')]},
  ],
  // 6) Chilling Cemetery — hardest course, gravestones
  [
    {start:{x:195,y:560}, cup:{x:195,y:90},  par:3, obstacles:[R(160,105,70,90,'grave')]},
    {start:{x:370,y:560},  cup:{x:330,y:120}, par:3, obstacles:[R(90,220,300,80,'grave'),R(-250,220,300,80,'grave')]},
    {start:{x:330,y:560}, cup:{x:60,y:100},  par:3, obstacles:[R(120,300,150,18,'grave')]},
    {start:{x:195,y:560}, cup:{x:195,y:110}, par:3, obstacles:[R(90,280,210,18,'grave')]},
    {start:{x:60,y:560},  cup:{x:330,y:90},  par:3, obstacles:[R(140,260,120,18,'grave')]},
    {start:{x:330,y:560}, cup:{x:60,y:120},  par:3, obstacles:[R(100,240,190,18,'grave')]},
    {start:{x:195,y:560}, cup:{x:195,y:100}, par:3, obstacles:[R(120,220,150,18,'grave')]},
    {start:{x:60,y:560},  cup:{x:330,y:110}, par:4, obstacles:[R(-150,390,480,78,'grave'),R(280,200,220,16,'grave')]},
    {start:{x:330,y:560}, cup:{x:60,y:90},   par:3, obstacles:[R(90,260,210,18,'grave')]},
  ],
];

// ======= Derived Course Pars =======
const COURSE_PAR = COURSES.map(course => course.reduce((a,h)=>a+h.par,0));

// ======= Persistent State =======
const SAVE_KEY = 'pocket_golf_v4';
const defaultState = {
  coins: 0,
  ownedBalls: { white:true },
  selectedBall: 'white',
  courses: [
    {name:'Meadow Run',    unlocked:true,  best:null},
    {name:'Desert Dunes',  unlocked:false, best:null},
    {name:'Forest Path',   unlocked:false, best:null},
    {name:'Emerald Slides',unlocked:false, best:null},
    {name:'Chaos Peaks',   unlocked:false, best:null},
    {name:'Chilling Cemetery', unlocked:true, best:null}, // auto-unlocked
  ]
};
let state = loadState();
function saveState(){ localStorage.setItem(SAVE_KEY, JSON.stringify(state)); }
function loadState(){
  try{ const raw = localStorage.getItem(SAVE_KEY); if(!raw) return structuredClone(defaultState);
    const parsed = JSON.parse(raw);
    const merged = structuredClone(defaultState);
    Object.assign(merged, parsed);
    for(let i=0;i<merged.courses.length;i++){
      if(parsed.courses && parsed.courses[i]) Object.assign(merged.courses[i], parsed.courses[i]);
    }
    if(!merged.ownedBalls) merged.ownedBalls={white:true};
    if(!merged.selectedBall) merged.selectedBall='white';
    return merged;
  }catch{ return structuredClone(defaultState); }
}
function resetProgress(){
  localStorage.removeItem(SAVE_KEY);
  state = structuredClone(defaultState);
  saveState();
  renderMenu();
}

// ======= UI (Menu/Shop) =======
const menuEl = document.getElementById('menu');
const shopEl = document.getElementById('shop');
const gameEl = document.getElementById('game');
const courseListEl = document.getElementById('courseList');
const bestScoresEl = document.getElementById('bestScores');

const BALL_STORE = [
  {id:'white',  name:'Classic White', price:0,   color:'#ffffff'},
  {id:'red',    name:'Ruby Red',       price:25,  color:'#ff4d4d'},
  {id:'blue',   name:'Ocean Blue',     price:25,  color:'#4d8dff'},
  {id:'yellow', name:'Sun Yellow',     price:50,  color:'#ffe14d'},
  {id:'purple', name:'Royal Purple',   price:100, color:'#a04dff'},
  {id:'mint',   name:'Mint Green',     price:150, color:'#7dffc4'},
  {id:'teal',   name:'Great Teal',     price:215, color:'#008080'},
  {id:'light',  name:'Exotic Blue',    price:300, color:'#40E0D0'},
  {id:'pumpkin',name:'Pumpkin Ball',   price:75,   color:'#FF7518'},
];

function show(el){ el.style.display='block'; }
function hide(el){ el.style.display='none'; }

function scoreToString(s){ if(s===0) return 'E'; return s>0?`+${s}`:`${s}`; }

function renderMenu(){
  hide(shopEl); hide(gameEl); show(menuEl);
  document.getElementById('menuCoins').textContent = state.coins;
  courseListEl.innerHTML='';
  state.courses.forEach((c,i)=>{
    const btn=document.createElement('button');
    const par = COURSE_PAR[i];
    const best = c.best==null? 'N/A' : scoreToString(c.best);
    btn.textContent = `${c.name} (Par ${par}) — Best: ${best}` + (c.unlocked?'':' 🔒');
    btn.disabled=!c.unlocked; btn.onclick=()=>startCourse(i);
    courseListEl.appendChild(btn);
  });
  bestScoresEl.innerHTML = state.courses.map((c,i)=>`${c.name}: Par ${COURSE_PAR[i]} • Best: ${c.best==null? 'N/A' : scoreToString(c.best)}`).join('<br>');
}

function openShop(){ hide(menuEl); show(shopEl); renderShop(); }
function backToMenu(){ renderMenu(); }

function renderShop(){
  document.getElementById('coins').textContent = state.coins;
  const wrap=document.getElementById('shopItems');
  wrap.innerHTML='';
  BALL_STORE.forEach(item=>{
    const row=document.createElement('div'); row.className='shop-item';
    const left=document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='10px';
    const sw=document.createElement('div'); sw.className='ball-swatch'; sw.style.background=item.color; left.appendChild(sw);
    const meta=document.createElement('div'); meta.innerHTML=`<div><strong>${item.name}</strong></div><div class="tiny">Price: ${item.price} coins</div>`; left.appendChild(meta);
    const right=document.createElement('div');
    const owned = !!state.ownedBalls[item.id];
    const btn=document.createElement('button');
    if(owned){ btn.textContent = state.selectedBall===item.id? 'Selected' : 'Select'; if(state.selectedBall===item.id) btn.disabled=true; btn.onclick=()=>{state.selectedBall=item.id; saveState(); renderShop();}; }
    else{ btn.textContent=`Buy (${item.price})`; btn.disabled = state.coins < item.price; btn.onclick=()=>{ if(state.coins>=item.price){ state.coins-=item.price; state.ownedBalls[item.id]=true; state.selectedBall=item.id; saveState(); renderShop(); } }; }
    right.appendChild(btn);
    row.appendChild(left); row.appendChild(right); wrap.appendChild(row);
  });
}

// ======= Game =======
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const hudHole = document.getElementById('hudHole');
const hudStrokes = document.getElementById('hudStrokes');
const hudScore = document.getElementById('hudScore');
const hudPar = document.getElementById('hudPar');
const hudCoins = document.getElementById('hudCoins');
const clubBtn = document.getElementById('clubBtn');
const summaryEl = document.getElementById('summary');
const summaryBody = document.getElementById('summaryBody');

const COIN_VALUE = 5; // each coin gives 5 coins
const MAX_PULL = 200;
const STOP_SPEED = 0.10;
const DRIVER_MAX_SPEED = 7.0;
const PUTTER_MAX_SPEED =4.0 // 50% harder than previous 1.3

let currentCourseIdx=0, holeIdx=0; // 0..8
let strokes=0, totalScore=0; // numeric relative to par
let currentPar=3;
let club='driver'; // 'driver' or 'putter'
let holeTransition=false; // guard to prevent skipping

const ball={x:195,y:540,vx:0,vy:0,r:9};
let dragging=false, dragX=0, dragY=0, aimDX=0, aimDY=0, powerPct=0;
let prevX=ball.x, prevY=ball.y;

let obstacles=[]; // {x,y,w,h,type}
let coinsOnHole=[]; // {x,y,r}
let cup={x:195,y:70,r:12};
let startPos={x:195,y:540};

clubBtn.onclick = ()=>{ club = (club==='driver'?'putter':'driver'); clubBtn.textContent = 'Club: ' + (club==='driver'?'Driver':'Putter'); };

function exitGame(){ hide(gameEl); renderMenu(); }

function startCourse(idx){
  currentCourseIdx=idx; holeIdx=0; strokes=0; totalScore=0; club='driver'; clubBtn.textContent='Club: Driver'; holeTransition=false;
  hide(menuEl); hide(shopEl); show(gameEl);
  setupHoleFromPreset();
  requestAnimationFrame(loop);
}

function nextHole(){
  if(holeIdx===8){ return endCourse(); }
  holeIdx++; holeTransition=false; setupHoleFromPreset();
}

function endCourse(){
  // record best & unlock next if E or better
  const course=state.courses[currentCourseIdx];
  if(course.best==null || totalScore < course.best){ course.best = totalScore; }
  const par = COURSE_PAR[currentCourseIdx];
  const resultOK = totalScore <= 0;
  if(resultOK && state.courses[currentCourseIdx+1]){ state.courses[currentCourseIdx+1].unlocked = true; }
  saveState();
  // summary overlay
  show(summaryEl);
  summaryBody.innerHTML = `Course: <strong>${course.name}</strong><br>`+
    `Total Par: <strong>${par}</strong><br>`+
    `Your total vs par: <strong>${scoreToString(totalScore)}</strong><br>`+
    `${resultOK? 'Nice! Next course unlocked.' : 'Finish E or better to unlock the next course.'}`;
}
function summaryToMenu(){ hide(summaryEl); exitGame(); }

function setupHoleFromPreset(){
  const preset = COURSES[currentCourseIdx][holeIdx];
  startPos = {x:preset.start.x, y:preset.start.y};
  ball.x=startPos.x; ball.y=startPos.y; ball.vx=0; ball.vy=0; prevX=ball.x; prevY=ball.y; dragging=false; powerPct=0;
  cup = {x:preset.cup.x, y:preset.cup.y, r:12};
  currentPar = preset.par;
  obstacles = preset.obstacles.map(o=>({...o}));
  spawnCoins();
  updateHUD();
}

function spawnCoins(){
  coinsOnHole=[]; const r=Math.random();
  if(r<0.25){ coinsOnHole.push(randCoin()); }
  else if(r<0.35){ coinsOnHole.push(randCoin(), randCoin()); }
}
function randCoin(){ return { x: 24+Math.random()*(canvas.width-48), y: 120+Math.random()*(canvas.height-180), r:6 }; }

function updateHUD(){
  hudHole.textContent = `Hole ${holeIdx+1}/9`;
  hudStrokes.textContent = `Strokes: ${strokes}`;
  hudScore.textContent = `Score: ${scoreToString(totalScore)}`;
  hudPar.textContent = `Par ${currentPar}`;
  hudCoins.textContent = state.coins;
}

// ======= Loop =======
function loop(){ update(); draw(); requestAnimationFrame(loop); }

function update(){
  // integrate
  prevX=ball.x; prevY=ball.y;
  ball.x += ball.vx; ball.y += ball.vy;
  // friction
  ball.vx *= 0.985; ball.vy *= 0.985;
  if(Math.hypot(ball.vx,ball.vy) < STOP_SPEED){ ball.vx=0; ball.vy=0; }

  // walls
  if(ball.x < ball.r){ ball.x=ball.r; ball.vx*=-0.7; }
  if(ball.x > canvas.width-ball.r){ ball.x=canvas.width-ball.r; ball.vx*=-0.7; }
  if(ball.y < ball.r){ ball.y=ball.r; ball.vy*=-0.7; }
  if(ball.y > canvas.height-ball.r){ ball.y=canvas.height-ball.r; ball.vy*=-0.7; }

  // obstacles
  obstacles.forEach(o=>{
    const inside = ball.x>o.x-ball.r && ball.x<o.x+o.w+ball.r && ball.y>o.y-ball.r && ball.y<o.y+o.h+ball.r;
    const wasInside = prevX>o.x-ball.r && prevX<o.x+o.w+ball.r && prevY>o.y-ball.r && prevY<o.y+o.h+ball.r;
    if(inside){
      if(o.type==='sand'){
        ball.vx *= 0.5; ball.vy *= 0.5; // slow 50%
      } else if(!wasInside){
        const penX = Math.min(Math.abs((o.x-ball.x)+ball.r), Math.abs((o.x+o.w-ball.x)-ball.r));
        const penY = Math.min(Math.abs((o.y-ball.y)+ball.r), Math.abs((o.y+o.h-ball.y)-ball.r));
        if(penX < penY){ ball.vx *= (o.type==='green'?-0.6:-0.35); }
        else{ ball.vy *= (o.type==='green'?-0.6:-0.35); }
      }
    }
  });

  // coins
  for(let i=coinsOnHole.length-1;i>=0;i--){
    const c=coinsOnHole[i];
    const d2=(ball.x-c.x)*(ball.x-c.x)+(ball.y-c.y)*(ball.y-c.y);
    if(d2 < (ball.r+c.r)*(ball.r+c.r)){
      coinsOnHole.splice(i,1);
      state.coins += COIN_VALUE; saveState(); updateHUD();
    }
  }

  // cup (guard against multi-trigger)
  if(!holeTransition){
    const d2=(ball.x-cup.x)*(ball.x-cup.x)+(ball.y-cup.y)*(ball.y-cup.y);
    if(d2 < cup.r*cup.r && Math.hypot(ball.vx,ball.vy) < 1.0){
      holeTransition=true;
      // finalize hole score
      totalScore += (strokes - currentPar);
      strokes = 0; updateHUD();
      setTimeout(()=>{ nextHole(); }, 400);
    }
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // If current course is Chilling Cemetery (index 5), draw brown floor; otherwise draw fairway stripes
  if(currentCourseIdx === 5){
    // brown cemetery floor
    ctx.fillStyle = '#5a3d2b';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    // subtle darker stripes
    for(let i=0;i<8;i++){
      ctx.fillStyle = `rgba(0,0,0,${0.02*(i%2)})`;
      ctx.fillRect(0,i*80,canvas.width,40);
    }
  } else {
    // fairway stripes
    for(let i=0;i<8;i++){ ctx.fillStyle = `rgba(255,255,255,${0.03*(i%2)})`; ctx.fillRect(0,i*80,canvas.width,40); }
  }

  // render obstacles
  obstacles.forEach(o=>{
    if(o.type==='sand'){
      const grd = ctx.createLinearGradient(o.x,o.y,o.x,o.y+o.h);
      grd.addColorStop(0,'#f7e8b6'); grd.addColorStop(1,'#e0cd8e');
      ctx.fillStyle = grd; roundRect(o.x,o.y,o.w,o.h,10,true,false);
      ctx.strokeStyle='rgba(0,0,0,.15)'; ctx.stroke();
    }else if(o.type==='green'){
      const grd = ctx.createLinearGradient(o.x,o.y,o.x+o.w,o.y);
      grd.addColorStop(0,'#77e382'); grd.addColorStop(1,'#34c759');
      ctx.fillStyle = grd; roundRect(o.x,o.y,o.w,o.h,10,true,false);
    }else if(o.type==='grave'){
      // gravestone (gray)
      const grd = ctx.createLinearGradient(o.x,o.y,o.x,o.y+o.h);
      grd.addColorStop(0,'#bdbdbd'); grd.addColorStop(1,'#8a8a8a');
      ctx.fillStyle = grd; roundRect(o.x,o.y,o.w,o.h,8,true,false);
      ctx.strokeStyle='rgba(0,0,0,.45)'; ctx.lineWidth=2; ctx.stroke();
      // small etched cross / mark for gravestone detail
      ctx.fillStyle='rgba(0,0,0,0.12)';
      const cx = o.x + o.w/2;
      const cy = o.y + o.h/2 - 4;
      ctx.fillRect(cx-1, cy-8, 2, 14);
      ctx.fillRect(cx-6, cy-1, 12, 2);
    }else{
      const grd = ctx.createLinearGradient(o.x,o.y,o.x,o.y+o.h);
      grd.addColorStop(0,'#a77746'); grd.addColorStop(1,'#7d5a34');
      ctx.fillStyle = grd; roundRect(o.x,o.y,o.w,o.h,10,true,false);
    }
  });

  // coins
  coinsOnHole.forEach(c=>{
    const grd=ctx.createRadialGradient(c.x-2,c.y-2,2,c.x,c.y,10);
    grd.addColorStop(0,'#fff8a8'); grd.addColorStop(1,'#e7b100');
    ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(c.x,c.y,c.r,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.25)'; ctx.stroke();
  });

  // cup
  ctx.beginPath(); ctx.arc(cup.x,cup.y,cup.r,0,Math.PI*2); ctx.fillStyle='#0b1110'; ctx.fill();
  ctx.beginPath(); ctx.arc(cup.x,cup.y,cup.r+4,0,Math.PI*2); ctx.strokeStyle='rgba(0,0,0,.35)'; ctx.lineWidth=3; ctx.stroke();
  // flag
  ctx.beginPath(); ctx.moveTo(cup.x, cup.y-cup.r-18); ctx.lineTo(cup.x, cup.y); ctx.strokeStyle='#1b1b1b'; ctx.lineWidth=3; ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cup.x, cup.y-cup.r-18); ctx.lineTo(cup.x+18, cup.y-cup.r-12); ctx.lineTo(cup.x, cup.y-cup.r-6); ctx.closePath(); ctx.fillStyle='#ffd34d'; ctx.fill();

  // ball
  const sel = BALL_STORE.find(b=>b.id===state.selectedBall) || BALL_STORE[0];
  const bgrd = ctx.createRadialGradient(ball.x-3,ball.y-3,2,ball.x,ball.y,ball.r);
  bgrd.addColorStop(0,'#ffffff'); bgrd.addColorStop(1, sel.color);
  ctx.beginPath(); ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2); ctx.fillStyle=bgrd; ctx.fill(); ctx.strokeStyle='rgba(0,0,0,.35)'; ctx.lineWidth=2; ctx.stroke();

  // aim line & power label
  if(dragging){
    ctx.beginPath(); ctx.moveTo(ball.x,ball.y); ctx.lineTo(dragX,dragY); ctx.lineWidth=3; ctx.setLineDash([8,6]); ctx.strokeStyle='rgba(255,255,255,.9)'; ctx.stroke(); ctx.setLineDash([]);
    ctx.font='bold 16px system-ui, -apple-system, Segoe UI'; ctx.textAlign='center'; ctx.textBaseline='bottom';
    ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(ball.x-30,ball.y-36,60,20);
    ctx.fillStyle='#eafff2'; ctx.fillText(`${Math.round(powerPct*100)}%`, ball.x, ball.y-20);
  }
}

function roundRect(x,y,w,h,r,fill,stroke){
  if(w<2*r) r=w/2; if(h<2*r) r=h/2; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); if(fill) ctx.fill(); if(stroke) ctx.stroke();
}

// ======= Input =======
function getCanvasPoint(clientX,clientY){ const r=canvas.getBoundingClientRect(); const x=(clientX-r.left)*(canvas.width/r.width); const y=(clientY-r.top)*(canvas.height/r.height); return {x,y}; }
function canShoot(){ return Math.hypot(ball.vx,ball.vy)<0.1 && !holeTransition; }
function startDrag(x,y){ if(Math.hypot(x-ball.x,y-ball.y)<=26 && canShoot()){ dragging=true; dragX=x; dragY=y; calcAim(); } }
function moveDrag(x,y){ if(!dragging) return; dragX=x; dragY=y; calcAim(); }
function endDrag(){ if(!dragging) return; dragging=false; const mag=Math.min(Math.hypot(aimDX,aimDY),MAX_PULL); const ang=Math.atan2(aimDY,aimDX);
  // club-specific range
  const minPct = (club==='driver'?0.25:0.01); const maxPct=(club==='driver'?1.0:0.60);
  let pct = powerPct; if(pct<minPct) pct=minPct; if(pct>maxPct) pct=maxPct;
  const MAX_SPEED = (club==='driver'? DRIVER_MAX_SPEED : PUTTER_MAX_SPEED);
  const speed = pct * MAX_SPEED;
  ball.vx = -Math.cos(ang)*speed; ball.vy = -Math.sin(ang)*speed; strokes++; updateHUD(); }
function calcAim(){ aimDX=dragX-ball.x; aimDY=dragY-ball.y; const mag=Math.min(Math.hypot(aimDX,aimDY),MAX_PULL); powerPct = mag / MAX_PULL; }

canvas.addEventListener('touchstart',e=>{ const t=e.touches[0]; const p=getCanvasPoint(t.clientX,t.clientY); startDrag(p.x,p.y); },{passive:true});
canvas.addEventListener('touchmove', e=>{ const t=e.touches[0]; const p=getCanvasPoint(t.clientX,t.clientY); moveDrag(p.x,p.y); },{passive:true});
canvas.addEventListener('touchend', ()=> endDrag());
canvas.addEventListener('mousedown', e=>{ const p=getCanvasPoint(e.clientX,e.clientY); startDrag(p.x,p.y); });
window.addEventListener('mousemove', e=>{ const p=getCanvasPoint(e.clientX,e.clientY); moveDrag(p.x,p.y); });
window.addEventListener('mouseup', ()=> endDrag());

// ======= Boot =======
function init(){ renderMenu(); }
init();
</script>
</body>
</html>
